---
title: "Interoperability"
author: "Junchen Yang"
date: "`r Sys.Date()`"
vignette: |
  %\VignetteIndexEntry{Interoperability} %\VignetteEngine{knitr::rmarkdown} %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  dev = "png", 
  dev.args = list(type = "cairo-png")
)
```


Interperobility with Scanpy

# Pkg prep

```{r message=F, warning=F}
# install NICHES
#devtools::install()
library(NICHES)

# Load ALRA
devtools::source_url('https://raw.githubusercontent.com/KlugerLab/ALRA/master/alra.R')

# Set up reticulate and the python env
#install.packages("reticulate")
library(reticulate)
Sys.setenv(RETICULATE_PYTHON = "/Library/Frameworks/Python.framework/Versions/3.10/bin/python3.10")
```


```{python}
import numpy as np
import matplotlib.pyplot as plt
import scanpy as sc
```

```{python Figure settings}
sc.set_figure_params(dpi=300,figsize=(20,16))
```

# Load the data and preprocess

```{python dev='png'}
# load the raw pbmc3k and the processed pbmc3k
adata = sc.datasets.pbmc3k()
adata2 = sc.datasets.pbmc3k_processed()
```

```{python Data Processing}
# Filtering
sc.pp.filter_cells(adata, min_genes=200)
sc.pp.filter_genes(adata, min_cells=3)
adata.var['mt'] = adata.var_names.str.startswith('MT-')
sc.pp.calculate_qc_metrics(adata, qc_vars=['mt'], percent_top=None, log1p=False, inplace=True)
adata = adata[adata.obs.n_genes_by_counts < 2500, :]
adata = adata[adata.obs.pct_counts_mt < 5, :]
# Log1p normalization
sc.pp.normalize_total(adata, target_sum=1e4)
sc.pp.log1p(adata)
# Assign labels
adata.obs['louvain'] = adata2.obs['louvain']
```

# Visualize the data
```{python}
with plt.rc_context({"figure.figsize": (8, 8), "figure.dpi": (300)}):
    sc.pl.umap(adata2, color='louvain',legend_loc ="on data")
```

# Subset to only 'B cells','CD4 T cells','CD14+ Monocytes'

```{python}
adata = adata[adata.obs['louvain'].isin(['B cells','CD4 T cells','CD14+ Monocytes']),:]

cell_names = np.array(adata.obs_names)
gene_names = np.array(adata.var_names)
```

# Extract the meta data and impute the data to run NICHES
```{r message=F, warning=F}
meta.data.df <- data.frame("louvain" = py$adata$obs$louvain,row.names = py$cell_names)

# alra imputation
imputed.list <- alra(as.matrix(py$adata$X$toarray()))
data.imputed <- t(imputed.list[[3]])

#potential bug: colnames and rownames of the matrix have to be set
colnames(data.imputed) <- py$cell_names
rownames(data.imputed) <- py$gene_names
```

# Run NICHES

```{r message=F, warning=F}
niches_list <- RunNICHES(data.imputed,
                 meta.data.df = meta.data.df,
                 cell_types = "louvain",
                 species = 'human',
                 LR.database = 'fantom5',
                 CellToCell = T,output_format = "raw"
                 )
lr_names <- rownames(niches_list$CellToCell$CellToCellMatrix)
```

# Convert the output to AnnData

```{python}
adata_niches = sc.AnnData(X = r.niches_list['CellToCell']['CellToCellMatrix'].T)
adata_niches.obs = r.niches_list['CellToCell']['metadata']
adata_niches.var_names = r.lr_names
```

# Process the output from NICHES using scanpy

```{python}
# data scaling, pca, find neighbors, and umap
sc.pp.scale(adata_niches)
sc.tl.pca(adata_niches)
sc.pp.neighbors(adata_niches)
sc.tl.umap(adata_niches)
```


# Visualize CellToCell matrix

```{python}
with plt.rc_context({"figure.figsize": (8, 8), "figure.dpi": (300)}):
    sc.pl.umap(adata_niches,color="VectorType",legend_loc ="on data",legend_fontsize=7)
```

# Differential LR analysis

```{python}
sc.tl.rank_genes_groups(adata_niches, 'VectorType', method='logreg', solver='liblinear',penalty='l1')
with plt.rc_context({"figure.figsize": (8, 12), "figure.dpi": (300)}):
    sc.pl.rank_genes_groups(adata_niches, n_genes=5, sharey=False,show=True,fontsize=20)
```

```{python}
marker_LRs = np.array([g for g in adata_niches.uns['rank_genes_groups']['names'][0]])
```



```{python}
# check specific LRs
with plt.rc_context({"figure.figsize": (10,7), "figure.dpi": (300),"font.size":(8)}):
    sc.pl.violin(adata_niches, marker_LRs[0], groupby='VectorType',rotation=20)
```

```{python}
with plt.rc_context({"figure.figsize": (8, 8), "figure.dpi": (300)}):
    sc.pl.umap(adata_niches, color=marker_LRs[:2],ncols=2)
```


```{python}
with plt.rc_context({"figure.dpi": (300),"font.size":(10)}):
    sc.pl.dotplot(adata_niches, marker_LRs, groupby='VectorType',figsize=(20,10))
```





# Interporability with  Monocle3 (CellDataSet)


```{r message=F, warning=F}
library(monocle3)
lr_metadata <- data.frame(lr_names)
rownames(lr_metadata) <- lr_names
cds <- new_cell_data_set(niches_list$CellToCell$CellToCellMatrix,
                         cell_metadata = niches_list$CellToCell$metadata,
                         gene_metadata = lr_metadata)

```

```{r message=F, warning=F}
# use all genes for pca
cds <- preprocess_cds(cds, num_dim = 30,
                      method = "PCA",norm_method = "none",scaling = TRUE,verbose = TRUE)
```

```{r message=F, warning=F}
cds <- reduce_dimension(cds)
```


```{r message=F, warning=F}
plot_cells(cds, color_cells_by="VectorType")
```




# Interporability with Scater (SingleCellExperiment)



```{r message=F, warning=F}
library(scater)
sce <- SingleCellExperiment(
    assays = list(data = niches_list$CellToCell$CellToCellMatrix), 
    colData = niches_list$CellToCell$metadata,
    rowData = lr_metadata
)
```


```{r message=F, warning=F}
sce <- runPCA(sce,exprs_values="data")
```

```{r message=F, warning=F}
plotExpression(sce,features = "GNAI2â€”C5AR1",exprs_values = "data",x = "VectorType",colour_by="VectorType")+
  theme(axis.text.x = element_text(angle = 60, vjust = 1, hjust=1))
```
```{r message=F, warning=F}
sce <- runUMAP(sce,exprs_values="data")
```

```{r message=F, warning=F}
plotUMAP(sce, colour_by = "VectorType")
```

