---
title: "Converting Single-Cell Atlases to Single-Cell Signaling Atlases with Monocle 3"
author: "Micha Sam Brickman Raredon & Junchen Yang"
date: "`r Sys.Date()`"
vignette: |
  %\VignetteIndexEntry{Converting Single-Cell Atlases to Single-Cell Signaling Atlases} %\VignetteEngine{knitr::rmarkdown} %\VignetteEncoding{UTF-8}
---


```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

NICHES is able to rapidly convert traditional single-cell atlases into single-cell signaling atlases which allow cell-cell signaling to be analyzed using existing single-cell software. Here, we leverage  publicly available PBMC data to demonstrate:

## Load Dependencies
```{r message=F, warning=F}
library(Seurat)
library(SeuratData)
library(SeuratWrappers)
library(NICHES)
library(dplyr)
library(ggplot2)
```

## Load and Visualize Single-Cell Data
Here, we use the 'pbmc3k' dataset from SeuratData. This is a commonly-used dataset showing options for the workflow.
```{r message=F, warning=F}
InstallData("pbmc3k")
data("pbmc3k")
Idents(pbmc3k) <- pbmc3k$seurat_annotations
pbmc3k <- ScaleData(pbmc3k)
pbmc3k <- FindVariableFeatures(pbmc3k)
pbmc3k <- RunPCA(pbmc3k)
ElbowPlot(pbmc3k,ndims=50)
pbmc3k <- RunUMAP(pbmc3k,dims = 1:10)
DimPlot(pbmc3k,reduction = 'umap',label = T,repel = F,label.size = 6)
```

For simplicity, let's focus in on signaling within a simple 3-cell system:
```{r message=F, warning=F}
sub <- subset(pbmc3k,idents = c('B','Naive CD4 T','CD14+ Mono'))
DimPlot(sub,reduction = 'umap',label = T,repel = F,label.size = 6)
```

## Convert to Cell-Cell Signaling Atlas
Here, we use the human-specific OmniPath database as our ground-truth ligand-receptor mechanism database, which includes some mechanisms with more than one subunit on both the sending and receiving arms:
```{r message=F, warning=F}
imputed <- SeuratWrappers::RunALRA(sub)
scc <- RunNICHES(imputed,
                 assay = 'alra',
                 species = 'human',
                 LR.database = 'omnipath',
                 CellToCell = T,output_format = "raw")
```


## Perform the downstream analysis using monocle3

```{r Install monocle3}
if (!requireNamespace("BiocManager", quietly = TRUE))
  install.packages("BiocManager")
#BiocManager::install(version = "3.14")

BiocManager::install(c('BiocGenerics', 'DelayedArray', 'DelayedMatrixStats',
                       'limma', 'lme4', 'S4Vectors', 'SingleCellExperiment',
                       'SummarizedExperiment', 'batchelor', 'Matrix.utils',
                       'HDF5Array', 'terra', 'ggrastr'))
#BiocManager::install('ggrastr')
#devtools::install_github('cole-trapnell-lab/leidenbase')
devtools::install_github('cole-trapnell-lab/monocle3')
```


```{r message=F, warning=F}
library(monocle3)
lr_metadata <- data.frame(rownames(scc$CellToCell$CellToCellMatrix))
rownames(lr_metadata) <- rownames(scc$CellToCell$CellToCellMatrix)
cds <- new_cell_data_set(scc$CellToCell$CellToCellMatrix,
                         cell_metadata = scc$CellToCell$metadata,
                         gene_metadata = lr_metadata)
```

```{r Data scaling and pca}
# use all genes for pca
colData(cds)[['Size_Factor']] <- 1 # check if this is ok
cds <- preprocess_cds(cds, num_dim = 30,
                      method = "PCA",norm_method = "none",scaling = TRUE,verbose = TRUE)
```

```{r UMAP}
cds <- reduce_dimension(cds)
```

```{r}
plot_cells(cds, color_cells_by="VectorType")
```

